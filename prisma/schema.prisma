// Shiftely - Slot-based scheduling schema
// Slot = unit of work (duration + people per slot)
// SlotAssignment = one person in one slot

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  GROWTH
  PRO
}

enum UserRole {
  EMPLOYEE
  MANAGER
  ADMIN
}

enum ScheduleStatus {
  DRAFT
  PUBLISHED
}

enum ScheduleType {
  WEEK
  EVENT
  CUSTOM
}

enum SlotStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SwapStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

model Organization {
  id                   String    @id @default(cuid())
  name                 String
  subscriptionTier     SubscriptionTier @default(FREE)
  trialEndsAt          DateTime?
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  settings             Json?     @default("{}")
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  users            User[]
  employees        Employee[]
  schedules        Schedule[]
  slots            Slot[]
  availabilityRequests AvailabilityRequest[]
  slotSwaps        SlotSwap[]
  timeTrackings    TimeTracking[]
  roles            Role[]
  invitations      Invitation[]
  employeeLeaves    EmployeeLeave[]
  employeeGroups   EmployeeGroup[]
  events           Event[]
  timeOffRequests  TimeOffRequest[]

  @@map("organizations")
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String?
  phone           String?
  passwordHash    String
  role            UserRole  @default(EMPLOYEE)
  organizationId  String
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization        Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee             Employee?
  createdSlots         Slot[]        @relation("SlotCreator")
  createdSchedules     Schedule[]    @relation("ScheduleCreator")
  notifications        Notification[]
  swapRequests         SlotSwap[]     @relation("SwapRequester")
  swapTargets          SlotSwap[]     @relation("SwapTarget")
  userRoles            UserRoleAssignment[] @relation("UserRoles")
  assignedRoles        UserRoleAssignment[] @relation("RoleAssigner")
  verificationTokens   VerificationToken[]
  passwordResetTokens  PasswordResetToken[]
  sentInvitations      Invitation[]  @relation("Inviter")
  publishedVersions    ScheduleVersion[]
  timeOffApprovals     TimeOffRequest[]
  scheduleChatMessages ScheduleChatMessage[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Employee {
  id                  String   @id @default(cuid())
  userId              String   @unique
  organizationId      String
  roleType            String?
  hourlyRate          Decimal? @db.Decimal(10, 2)
  availabilityTemplate Json?    @default("{}")
  skills              Json?    @default("[]")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  slotAssignments   SlotAssignment[]
  availabilityRequests AvailabilityRequest[]
  timeTrackings     TimeTracking[]
  leaves            EmployeeLeave[]
  timeOffRequests   TimeOffRequest[]
  groupMemberships  EmployeeGroupMember[]

  @@index([organizationId])
  @@index([userId])
  @@map("employees")
}

model EmployeeGroup {
  id             String   @id @default(cuid())
  name           String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      EmployeeGroupMember[]

  @@index([organizationId])
  @@map("employee_groups")
}

model EmployeeGroupMember {
  groupId    String
  employeeId String

  group    EmployeeGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  employee Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@id([groupId, employeeId])
  @@index([employeeId])
  @@map("employee_group_members")
}

model EmployeeLeave {
  id             String   @id @default(cuid())
  employeeId     String
  organizationId String
  startDate      DateTime
  endDate        DateTime
  type           String
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([organizationId])
  @@index([startDate])
  @@index([endDate])
  @@map("employee_leaves")
}

model TimeOffRequest {
  id             String   @id @default(cuid())
  employeeId     String
  organizationId String
  startDate      DateTime
  endDate        DateTime
  type           String
  notes          String?
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approverId     String?
  respondedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  approver     User?        @relation(fields: [approverId], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@index([organizationId])
  @@index([status])
  @@map("time_off_requests")
}

model Event {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  startDate      DateTime
  endDate        DateTime?
  venue          String?
  metadata       Json?    @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  schedules    Schedule[]

  @@index([organizationId])
  @@map("events")
}

model Schedule {
  id              String         @id @default(cuid())
  organizationId  String
  type            ScheduleType   @default(WEEK)
  weekStartDate   DateTime?      // when type = WEEK
  eventId         String?        // when type = EVENT
  startDate       DateTime?      // when type = CUSTOM
  endDate         DateTime?     // when type = CUSTOM
  name            String?
  slug            String?        @unique // name - week, e.g. front-of-house-jan-13-2025-abc12
  displaySettings Json?          // { startHour, endHour, workingDays }
  status          ScheduleStatus @default(DRAFT)
  createdById     String
  createdAt       DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User            @relation("ScheduleCreator", fields: [createdById], references: [id])
  event          Event?          @relation(fields: [eventId], references: [id], onDelete: SetNull)
  slots          Slot[]
  versions       ScheduleVersion[]
  chatMessages   ScheduleChatMessage[]

  @@index([organizationId])
  @@index([weekStartDate])
  @@index([eventId])
  @@map("schedules")
}

model ScheduleChatMessage {
  id         String   @id @default(cuid())
  scheduleId String
  userId     String?  // null for system messages
  body       String
  type       String   // "user" | "system"
  metadata   Json?    @default("{}") // e.g. { kind: "swap_requested", swapId }
  createdAt  DateTime @default(now())

  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([scheduleId])
  @@index([createdAt])
  @@map("schedule_chat_messages")
}

model ScheduleVersion {
  id           String   @id @default(cuid())
  scheduleId   String
  version      Int
  slotSnapshot Json     // { slotId: { assignments: [{ employeeId }] } }
  publishedById String
  publishedAt  DateTime @default(now())

  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  publishedBy User     @relation(fields: [publishedById], references: [id])

  @@unique([scheduleId, version])
  @@index([scheduleId])
  @@map("schedule_versions")
}

// Slot = unit of work: duration (startTime->endTime) + people per slot (minCount..maxCount)
model Slot {
  id             String     @id @default(cuid())
  organizationId String
  scheduleId     String
  startTime      DateTime
  endTime        DateTime
  position       String?
  requiredCount  Int        @default(1)  // target number of people (used when min/max not set)
  minCount       Int?       // optional minimum people for this shift; null = use requiredCount
  maxCount       Int?       // optional maximum people for this shift; null = use requiredCount
  status         SlotStatus @default(SCHEDULED)
  metadata       Json?      @default("{}")
  createdById    String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  schedule       Schedule       @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  createdBy      User           @relation("SlotCreator", fields: [createdById], references: [id])
  assignments    SlotAssignment[]
  slotSwaps      SlotSwap[]
  timeTrackings  TimeTracking[]

  @@index([organizationId])
  @@index([scheduleId])
  @@index([startTime])
  @@map("slots")
}

// SlotAssignment = one person in one slot (employeeId null = open slot)
model SlotAssignment {
  id         String   @id @default(cuid())
  slotId     String
  employeeId String?
  slotIndex  Int?     // which slot 1 of requiredCount (for display order)
  metadata   Json?    @default("{}")

  slot       Slot      @relation(fields: [slotId], references: [id], onDelete: Cascade)
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  @@index([slotId])
  @@index([employeeId])
  @@map("slot_assignments")
}

model AvailabilityRequest {
  id           String        @id @default(cuid())
  employeeId   String
  organizationId String
  date         DateTime
  status       RequestStatus @default(PENDING)
  reason       String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  employee     Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([date])
  @@map("availability_requests")
}

model SlotSwap {
  id                 String     @id @default(cuid())
  slotId             String
  slotAssignmentId   String?     // which assignment is being swapped (when multi-slot)
  organizationId     String
  requesterId        String
  targetEmployeeId   String?
  status             SwapStatus  @default(PENDING)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  slot               Slot       @relation(fields: [slotId], references: [id], onDelete: Cascade)
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requester          User       @relation("SwapRequester", fields: [requesterId], references: [id])
  targetEmployee     User?      @relation("SwapTarget", fields: [targetEmployeeId], references: [id], onDelete: SetNull)

  @@index([slotId])
  @@index([requesterId])
  @@index([organizationId])
  @@map("slot_swaps")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  message   String
  read      Boolean  @default(false)
  metadata  Json?    @default("{}")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

model TimeTracking {
  id            String   @id @default(cuid())
  slotId        String
  employeeId    String
  organizationId String
  clockIn       DateTime?
  clockOut      DateTime?
  totalHours    Decimal?  @db.Decimal(10, 2)
  overtimeHours Decimal?  @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  slot         Slot         @relation(fields: [slotId], references: [id], onDelete: Cascade)
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([slotId])
  @@index([employeeId])
  @@index([organizationId])
  @@map("time_trackings")
}

model Permission {
  id          String   @id @default(cuid())
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@unique([resource, action], name: "resource_action")
  @@index([resource])
  @@map("permissions")
}

model Role {
  id            String   @id @default(cuid())
  organizationId String
  name          String
  description   String?
  isSystemRole  Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]
  userRoles       UserRoleAssignment[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("roles")
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id           String   @id @default(cuid())
  userId       String
  roleId       String
  assignedById String
  assignedAt   DateTime @default(now())

  user       User @relation("UserRoles", fields: [userId], references: [id], onDelete: Cascade)
  role       Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedBy User @relation("RoleAssigner", fields: [assignedById], references: [id])

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model Invitation {
  id             String          @id @default(cuid())
  email          String
  organizationId String
  invitedById    String
  token          String          @unique
  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User           @relation("Inviter", fields: [invitedById], references: [id])

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("invitations")
}

model Lead {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  phone     String?
  source    String?
  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
  @@map("leads")
}
