// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  GROWTH
  PRO
}

enum UserRole {
  EMPLOYEE
  MANAGER
  ADMIN
}

enum ScheduleStatus {
  DRAFT
  PUBLISHED
}

enum ShiftStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SwapStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

model Organization {
  id                  String           @id @default(cuid())
  name                String
  subscriptionTier    SubscriptionTier @default(FREE)
  stripeCustomerId   String?          @unique
  stripeSubscriptionId String?         @unique
  settings            Json?            @default("{}")
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  users           User[]
  employees       Employee[]
  shifts          Shift[]
  schedules       Schedule[]
  availabilityRequests AvailabilityRequest[]
  shiftSwaps      ShiftSwap[]
  timeTrackings   TimeTracking[]
  roles           Role[]
  invitations     Invitation[]

  @@map("organizations")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  phone          String?
  passwordHash   String
  role           UserRole @default(EMPLOYEE)
  organizationId String
  emailVerified  Boolean  @default(false)
  emailVerifiedAt DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee       Employee?
  createdShifts  Shift[]      @relation("ShiftCreator")
  createdSchedules Schedule[] @relation("ScheduleCreator")
  notifications  Notification[]
  swapRequests   ShiftSwap[]   @relation("SwapRequester")
  swapTargets   ShiftSwap[]    @relation("SwapTarget")
  userRoles      UserRole[]
  assignedRoles  UserRole[]    @relation("RoleAssigner")
  verificationTokens VerificationToken[]
  passwordResetTokens PasswordResetToken[]
  sentInvitations Invitation[] @relation("Inviter")

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Employee {
  id                  String   @id @default(cuid())
  userId              String   @unique
  organizationId      String
  roleType            String?
  hourlyRate          Decimal? @db.Decimal(10, 2)
  availabilityTemplate Json?   @default("{}")
  skills              Json?    @default("[]")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  shifts              Shift[]
  availabilityRequests AvailabilityRequest[]
  timeTrackings       TimeTracking[]

  @@index([organizationId])
  @@index([userId])
  @@map("employees")
}

model Schedule {
  id            String         @id @default(cuid())
  organizationId String
  weekStartDate DateTime
  status        ScheduleStatus @default(DRAFT)
  createdById   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy     User           @relation("ScheduleCreator", fields: [createdById], references: [id])
  scheduleShifts ScheduleShift[]

  @@index([organizationId])
  @@index([weekStartDate])
  @@map("schedules")
}

model Shift {
  id            String     @id @default(cuid())
  organizationId String
  employeeId    String?
  startTime     DateTime
  endTime       DateTime
  position      String?
  status        ShiftStatus @default(SCHEDULED)
  createdById   String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee      Employee?    @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  createdBy     User        @relation("ShiftCreator", fields: [createdById], references: [id])
  scheduleShifts ScheduleShift[]
  shiftSwaps    ShiftSwap[]
  timeTrackings TimeTracking[]

  @@index([organizationId])
  @@index([employeeId])
  @@index([startTime])
  @@map("shifts")
}

model ScheduleShift {
  scheduleId String
  shiftId    String

  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  shift      Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@id([scheduleId, shiftId])
  @@map("schedule_shifts")
}

model AvailabilityRequest {
  id           String        @id @default(cuid())
  employeeId   String
  organizationId String
  date         DateTime
  status       RequestStatus @default(PENDING)
  reason       String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  employee     Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([date])
  @@map("availability_requests")
}

model ShiftSwap {
  id                String     @id @default(cuid())
  shiftId            String
  requesterId        String
  targetEmployeeId   String?
  status             SwapStatus @default(PENDING)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  shift              Shift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  requester          User       @relation("SwapRequester", fields: [requesterId], references: [id])
  targetEmployee     User?      @relation("SwapTarget", fields: [targetEmployeeId], references: [id], onDelete: SetNull)

  @@index([shiftId])
  @@index([requesterId])
  @@map("shift_swaps")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  message   String
  read      Boolean  @default(false)
  metadata  Json?    @default("{}")
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

model TimeTracking {
  id            String   @id @default(cuid())
  shiftId      String
  employeeId   String
  organizationId String
  clockIn      DateTime?
  clockOut     DateTime?
  totalHours   Decimal? @db.Decimal(10, 2)
  overtimeHours Decimal? @db.Decimal(10, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  shift        Shift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  employee     Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([shiftId])
  @@index([employeeId])
  @@index([organizationId])
  @@map("time_tracking")
}

model Permission {
  id          String   @id @default(cuid())
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@unique([resource, action], name: "resource_action")
  @@index([resource])
  @@map("permissions")
}

model Role {
  id            String   @id @default(cuid())
  organizationId String
  name          String
  description   String?
  isSystemRole  Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("roles")
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  id          String   @id @default(cuid())
  userId      String
  roleId      String
  assignedById String
  assignedAt  DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedBy  User     @relation("RoleAssigner", fields: [assignedById], references: [id])

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model Invitation {
  id             String          @id @default(cuid())
  email          String
  organizationId String
  invitedById    String
  token          String          @unique
  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy      User            @relation("Inviter", fields: [invitedById], references: [id])

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("invitations")
}
